const express = require('express');
const handlers = require('./handlers');
var bodyParser = require('body-parser');
const port = 3000;
let app = express();
app.use(bodyParser.json());

async function proveDeposit(req, res) {
	console.log(req.body);
	let result = handlers.proveDeposit(handlers.unstringify(req.body));
	console.log(result);
	res.send(handlers.stringify(result));
}

async function proveWithdrawal(req, res) {
	let result = handlers.proveWithdrawal(handlers.unstringify(req.body));
	res.send(handlers.stringify(result));
}

function proveTransaction(req, res) {
	console.log(req.body);
	let data = handlers.unstringify(req.body);
	let result = handlers.proveTransaction(data.txIn1, data.txIn2, data.txOut1, data.txOut2, data.fakeHashes);
	console.log(result);
	res.send(handlers.stringify(result));
}

function verifyDeposit(req, res) {
	res.send(handlers.verifyDeposit(handlers.unstringify(req.body)));
}

function verifyWithdrawal(req, res) {
	res.send(handlers.verifyWithdrawal(handlers.unstringify(req.body)));
}

function verifyTransaction(req, res) {
	res.send(handlers.verifyTransaction(handlers.unstringify(req.body)));
}

app.post('/prove-deposit', proveDeposit);
app.post('/prove-withdrawal', proveWithdrawal);
app.post('/prove-transaction', proveTransaction);
app.post('/verify-deposit', verifyDeposit);
app.post('/verify-withdrawal', verifyWithdrawal);
app.post('/verify-transaction', verifyTransaction);
app.get('/', (req, res) => { res.send("Hello"); });

handlers.load();

let server = app.listen(port, () => {
  console.log("Express server listening on port " + port);
});


/*
Examples:

POST /prove-deposit, POST /prove-withdraw

{ "balance": "321488905428287453363989606204499985466",
  "salt": "5149157721255631752077661259559006",
  "owner": "459418993075025202163780373805394412891310183763" }

response:

{"proof":{"pi_a":["21167731325875670848878398048862804811594668054049252741606410942454107927794","21122358537663032973342134691289713247614827200765237216719231732508121703403","1"],"pi_b":[["383887557478858538273202765282468253886562914466831898841025081607735768092","6416317874666804858850400617530998393085907801919343871305559510068414148888"],["838158857635885757187948368029896992285862095213496804275384518065291490511","893872646424726482150086705373006785798840467406588607605387945176130614471"],["1","0"]],"pi_c":["11500145997600824182475010428064131820330538508097150436660201665968355623694","2017061155712552823266335017094590213336612009341399722272678648697969763196","1"],"protocol":"groth"},"publicSignals":["321488905428287453363989606204499985466","5149157721255631752077661259559006","459418993075025202163780373805394412891310183763","18029507226528251362268272019956669113554416764004133351094155024702618803528"]}

POST /verify-withdrawal

{"proof":{"pi_a":["15362860256474807002878662047156062701938779476200885306962131782718811014439","523530373907297158449023650877819161864523925373505787373445457885483960231","1"],"pi_b":[["14589066783638339416743287544192871706239672229601888741089861713969109551461","3161626994445813970659342425346323029409608447063827824854215230560737232830"],["21599843745346048755617489678193194286798048712258907763707332186178560076789","12742961595329148413302750551933630769845548063355030300457775397808306359392"],["1","0"]],"pi_c":["14666464442011094498115081354307556829790311206888753148812728156652159426604","7853145876848132235372003090835027878812048134171718394372628150988964149863","1"],"protocol":"groth"},"publicSignals":["321488905428287453363989606204499985466","5149157721255631752077661259559006","459418993075025202163780373805394412891310183763","18029507226528251362268272019956669113554416764004133351094155024702618803528"]}

response:

true

POST /prove-transaction

{
	
}

response:

{"proof":{"pi_a":["21167731325875670848878398048862804811594668054049252741606410942454107927794","21122358537663032973342134691289713247614827200765237216719231732508121703403","1"],"pi_b":[["383887557478858538273202765282468253886562914466831898841025081607735768092","6416317874666804858850400617530998393085907801919343871305559510068414148888"],["838158857635885757187948368029896992285862095213496804275384518065291490511","893872646424726482150086705373006785798840467406588607605387945176130614471"],["1","0"]],"pi_c":["11500145997600824182475010428064131820330538508097150436660201665968355623694","2017061155712552823266335017094590213336612009341399722272678648697969763196","1"],"protocol":"groth"},"publicSignals":["321488905428287453363989606204499985466","5149157721255631752077661259559006","459418993075025202163780373805394412891310183763","18029507226528251362268272019956669113554416764004133351094155024702618803528"]}


 */